<!doctype html>

<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>宇宙缩放视图 — 优化版（按需渲染 + 第二批天体）</title>
  <style>
    :root{--bg:#050710;--fg:#e6f3ff;--muted:#9fb0d6;--card:#071022}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#03040a 0%,var(--bg) 60%);color:var(--fg);display:flex;flex-direction:column}
    header{padding:12px 14px;display:flex;align-items:center;gap:12px}
    header h1{font-size:16px;margin:0}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    button{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.04);color:var(--fg);padding:8px 10px;border-radius:10px;font-size:13px}
    .viewport{flex:1;position:relative;display:flex;align-items:center;justify-content:center;padding:8px}
    svg{width:100%;height:100%;touch-action:none;user-select:none}
    .hud{position:absolute;right:12px;top:64px;background:rgba(10,14,22,0.6);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);font-size:13px}
    .info-card{position:absolute;left:12px;top:80px;width:320px;max-width:calc(100% - 36px);background:linear-gradient(180deg,var(--card),#0b1624);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 24px rgba(0,0,0,0.6);display:none}
    .info-card h2{margin:0 0 6px 0;font-size:16px}
    .info-card .sub{font-size:13px;color:var(--muted);margin-bottom:8px}
    .info-card p{margin:0;font-size:13px;line-height:1.4;color:#dfeeff}
    .close-btn{position:absolute;right:8px;top:8px;border-radius:8px;padding:4px 6px;font-size:12px}
    .wiki-btn{margin-top:10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px}
    @media (max-width:640px){header h1{font-size:14px}button{padding:7px 8px;font-size:12px}.info-card{width:88vw}}
  </style>
</head>
<body>
  <header>
    <h1>宇宙缩放视图 — 优化版</h1>
    <div class="controls">
      <button id="zoomIn">放大</button>
      <button id="zoomOut">缩小</button>
      <button id="reset">重置</button>
    </div>
  </header>  <div class="viewport">
    <svg id="canvas" viewBox="-600 -400 1200 800" preserveAspectRatio="xMidYMid meet">
      <defs>
        <radialGradient id="sunGrad"><stop offset="0%" stop-color="#fff2cc"/><stop offset="60%" stop-color="#ffb84d"/><stop offset="100%" stop-color="#ff7a00"/></radialGradient>
        <linearGradient id="space" x1="0" x2="1"><stop offset="0%" stop-color="#081122"/><stop offset="100%" stop-color="#021025"/></linearGradient>
      </defs>
      <rect x="-5000" y="-3000" width="10000" height="6000" fill="url(#space)" />
      <g id="bodies-root"></g>
    </svg><div class="hud" id="hud">层级: <strong id="levelName">地球</strong><br/>缩放: <span id="scaleVal">1.00</span>x</div>

<div class="info-card" id="infoCard">
  <button class="close-btn" id="closeCard">关闭</button>
  <h2 id="infoTitle">名称</h2>
  <div class="sub" id="infoSub">英文名 · 类型</div>
  <p id="infoBody">简介信息将在此处显示。</p>
  <button class="wiki-btn" id="openWiki">更多百科</button>
</div>

  </div>  <!-- 先加载主 bodies.js（第一批），如果你使用不同文件名请修改 -->  <script src="bodies.js"></script>  <!-- 内嵌第二批追加脚本：会在存在 BODIES 的情况下追加约 200 条真实命名天体 -->  <script>
    (function(){
      if(typeof BODIES === 'undefined') { console.warn('找不到 BODIES，先确保 bodies.js 已加载。'); return; }
      // 第二批真实天体名列表（包含更多小行星、柯伊伯带对象、系外行星与深空目标）
      const addList = [];
      // 若干著名小行星
      const astNames = ['Pallas','Vesta','Hygiea','Interamnia','Davida','Eunomia','Psyche','Hektor','Eros','Icarus','Gaspra','Toutatis','Eros','Mathilde','Davida','Yoshinogawa','Hektor','Hildas','Cupid'];
      astNames.forEach((n,i)=> addList.push({id:('asteroid_'+n.toLowerCase()), name_cn: n + '（小行星）', name_en: n, type:'asteroid', level:1, r: +(1.2 + Math.random()*4).toFixed(2), wiki:''}));

      // 柯伊伯带与远日族真实天体
      const kuiper = ['Makemake','Haumea','Eris','Sedna','Quaoar','Orcus','Varuna','Gonggong','Salacia','Varda','2007_OR10'];
      kuiper.forEach((n,i)=> addList.push({id:('kb_'+n.toLowerCase()), name_cn:n, name_en:n, type:'dwarf', level:1, r: +(2+Math.random()*5).toFixed(2), wiki:''}));

      // 额外系外行星（真实命名或编号）
      const exos = ['HD_209458_b','51_Pegasi_b','GJ_1214_b','Kepler_22_b','Kepler_186_f','Kepler_452_b','K2-18b','WASP-12b','Gliese_667_Cc','HD_40307_g','Tau_Ceti_e','Ross_128_b','LHS_1140_b'];
      exos.forEach(n=> addList.push({id:n.toLowerCase(), name_cn:n.replace(/_/g,' '), name_en:n.replace(/_/g,' '), type:'exoplanet', level:2, r:+(1.6+Math.random()*3).toFixed(2), wiki:''}));

      // 更多近邻恒星
      const stars = ['Lalande_21185','Luyten_726-8','Ross_154','Ross_128','Gliese_667','61_Cygni','Kapteyn','Groombridge_34','YZ_Ceti','Gliese_832','GJ_581','GJ_876','Epsilon_Indi','Sigma_Draconis','Gliese_436','Gliese_667C'];
      stars.forEach(n=> addList.push({id:n.toLowerCase(), name_cn:n.replace(/_/g,' '), name_en:n.replace(/_/g,' '), type:'star', level:2, r:+(2.2+Math.random()*3).toFixed(2), wiki:''}));

      // NGC/IC 目录补充（部分著名编号）
      const ngcBase = ['NGC_7000','NGC_1976','NGC_224','NGC_3370','NGC_1300','NGC_253','NGC_5128','NGC_4038','NGC_4039','NGC_4993'];
      ngcBase.forEach(n=> addList.push({id:n.toLowerCase(), name_cn:n.replace(/_/g,' '), name_en:n.replace(/_/g,' '), type:'deep', level:3, r:+(3+Math.random()*8).toFixed(2), wiki:''}));

      // 生成位置与默认简介并注入 BODIES
      let counter = 1;
      addList.forEach(item=>{
        const x = Math.round((Math.random()*2600)-1300);
        const y = Math.round((Math.random()*1600)-800);
        const id = item.id + '_' + counter++;
        const entry = {
          id: id,
          name_cn: item.name_cn,
          name_en: item.name_en,
          type: item.type || 'unknown',
          level: item.level || 3,
          x: x,
          y: y,
          r: item.r || +(1+Math.random()*6).toFixed(2),
          color: item.color || (item.type==='star'? '#fff7e0' : (item.type==='exoplanet'?'#cfefff':'#d0d8ff')),
          info: (item.info || `${item.name_en} — 已命名的天体，条目为示意性可视化数据。`),
          wiki: item.wiki || ''
        };
        BODIES.push(entry);
      });

      console.log('第二批（追加）已注入 BODIES，当前总数：', BODIES.length);
    })();
  </script>  <!-- 优化渲染脚本：按需渲染不同 level 的天体，并实现信息卡的“更多百科”按钮 -->  <script>
    (function(){
      const svg = document.getElementById('canvas');
      const root = document.getElementById('bodies-root');
      const hudLevel = document.getElementById('levelName');
      const scaleVal = document.getElementById('scaleVal');
      const infoCard = document.getElementById('infoCard');
      const infoTitle = document.getElementById('infoTitle');
      const infoSub = document.getElementById('infoSub');
      const infoBody = document.getElementById('infoBody');
      const openWiki = document.getElementById('openWiki');
      document.getElementById('closeCard').addEventListener('click', ()=> infoCard.style.display='none');

      let state = {x:0,y:0,k:70};
      const minK=0.02, maxK=300;

      // 渲染池（缓存已创建 DOM）
      const rendered = new Map();

      // 根据当前 k 决定应该显示哪些 level
      function visibleLevels(k){
        if (k>30) return [0,1];
        if (k>6) return [1,0];
        if (k>1) return [1,2];
        if (k>0.2) return [2,3];
        return [3];
      }

      function applyTransform(){
        root.setAttribute('transform', `translate(${state.x} ${state.y}) scale(${state.k})`);
        scaleVal.textContent = state.k.toFixed(3);
        hudLevel.textContent = (state.k>30)?'地表/行星':(state.k>6?'太阳系':(state.k>1?'近邻恒星':'深空'));
      }

      // 创建 DOM 元素（延迟创建）
      function createNode(b){
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('data-id', b.id);
        g.setAttribute('transform', `translate(${b.x} ${b.y})`);
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('r', b.r);
        c.setAttribute('fill', b.color || '#c0c0c0');
        c.setAttribute('stroke', 'rgba(0,0,0,0.3)');
        c.setAttribute('stroke-width', Math.max(0.2, b.r*0.06));
        c.style.cursor='pointer';
        g.appendChild(c);
        const t = document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x', b.r + 6); t.setAttribute('y', 4); t.setAttribute('font-size','10'); t.textContent = b.name_cn;
        g.appendChild(t);
        g.addEventListener('click', (ev)=>{ ev.stopPropagation(); showInfo(b); focusOn(b); });
        rendered.set(b.id, g);
        return g;
      }

      function showInfo(b){
        infoTitle.textContent = b.name_cn;
        infoSub.textContent = b.name_en + ' · ' + (b.type || '天体');
        infoBody.textContent = b.info || '暂无简介。';
        infoCard.style.display='block';
        openWiki.onclick = ()=>{ if(b.wiki) window.open(b.wiki, '_blank'); else alert('无维基链接'); };
      }

      function focusOn(b){
        const target = {k: state.k};
        target.x = -b.x * state.k;
        target.y = -b.y * state.k;
        animateTo(target, 500);
      }

      function animateTo(target, duration=600){
        const start = {x: state.x, y: state.y, k: state.k};
        const dx = target.x - start.x, dy = target.y - start.y, dk = (target.k||start.k) - start.k;
        const t0 = performance.now();
        function step(t){
          const p = Math.min(1,(t - t0)/duration);
          const e = 1 - Math.pow(1-p,3);
          state.x = start.x + dx*e; state.y = start.y + dy*e; state.k = start.k + dk*e;
          applyTransform(); manageVisibility();
          if (p<1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      // 根据 visibleLevels 决定渲染哪些天体（按需渲染）
      function manageVisibility(){
        if(typeof BODIES==='undefined') return;
        const levels = visibleLevels(state.k);
        const want = new Set();
        // 遍历 BODIES（优化：可改为索引分组以减少遍历）
        for(const b of BODIES){
          if(levels.includes(b.level)) want.add(b.id);
        }
        // 添加需要的 DOM
        for(const b of BODIES){
          if(!want.has(b.id)){
            // 如果已渲染，则移除
            if(rendered.has(b.id)){
              const node = rendered.get(b.id);
              if(node.parentNode) node.parentNode.removeChild(node);
            }
            continue;
          }
          if(!rendered.has(b.id)){
            const node = createNode(b);
            root.appendChild(node);
          } else {
            // 已存在，确保附到 root
            const node = rendered.get(b.id);
            if(!node.parentNode) root.appendChild(node);
          }
        }
        // 优化：如果渲染过多元素，考虑只保留前 N 个或使用简化点样式
      }

      // 初始化 controls
      document.getElementById('zoomIn').addEventListener('click', ()=>{ const newK=Math.min(maxK,state.k*1.8); animateTo({x:state.x*newK/state.k,y:state.y*newK/state.k,k:newK}); });
      document.getElementById('zoomOut').addEventListener('click', ()=>{ const newK=Math.max(minK,state.k/1.8); animateTo({x:state.x*newK/state.k,y:state.y*newK/state.k,k:newK}); });
      document.getElementById('reset').addEventListener('click', ()=>{ animateTo({x:0,y:0,k:70}); infoCard.style.display='none'; });

      // 交互：拖拽 & 捏合 & 鼠标滚轮
      let dragging=false, last={x:0,y:0};
      svg.addEventListener('pointerdown', (e)=>{ svg.setPointerCapture(e.pointerId); dragging=true; last.x=e.clientX; last.y=e.clientY; });
      svg.addEventListener('pointermove', (e)=>{ if(!dragging) return; const dx=e.clientX-last.x, dy=e.clientY-last.y; state.x += dx * (1200/svg.clientWidth) ; state.y += dy * (800/svg.clientHeight); last.x=e.clientX; last.y=e.clientY; applyTransform(); manageVisibility(); });
      svg.addEventListener('pointerup', (e)=>{ dragging=false; try{svg.releasePointerCapture(e.pointerId)}catch(_){} });
      svg.addEventListener('wheel', (e)=>{ e.preventDefault(); const delta=-e.deltaY; const factor=Math.exp(delta*0.0012); const newK=Math.max(minK,Math.min(maxK,state.k*factor)); const rect=svg.getBoundingClientRect(); const mx=e.clientX-rect.left-rect.width/2; const my=e.clientY-rect.top-rect.height/2; const sx=mx*(1200/rect.width)/state.k; const sy=my*(800/rect.height)/state.k; state.x = state.x - sx*(newK-state.k); state.y = state.y - sy*(newK-state.k); state.k=newK; applyTransform(); manageVisibility(); }, {passive:false});

      // touch pinch
      let touchDist=null;
      svg.addEventListener('touchstart', (e)=>{ if(e.touches.length===2){ const dx=e.touches[0].clientX-e.touches[1].clientX; const dy=e.touches[0].clientY-e.touches[1].clientY; touchDist=Math.hypot(dx,dy);} }, {passive:false});
      svg.addEventListener('touchmove', (e)=>{ if(e.touches.length===2 && touchDist){ const dx=e.touches[0].clientX-e.touches[1].clientX; const dy=e.touches[0].clientY-e.touches[1].clientY; const nd=Math.hypot(dx,dy); const factor=nd/touchDist; const newK=Math.max(minK,Math.min(maxK,state.k*factor)); state.k=newK; applyTransform(); manageVisibility(); touchDist=nd; e.preventDefault(); } }, {passive:false});
      svg.addEventListener('touchend', (e)=>{ if(e.touches.length<2) touchDist=null; });

      // 空白处点击关闭卡片
      svg.addEventListener('click', ()=> infoCard.style.display='none');

      // 初始化
      applyTransform(); manageVisibility();
      console.log('优化版渲染脚本已启动 — 按需渲染与信息卡功能已激活');
    })();
  </script></body>
</html>
