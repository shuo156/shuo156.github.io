<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>复杂体积着色器 + 粒子 + 光影性能测试</title>
<style>
  body,html { margin:0; padding:0; overflow:hidden; background:#131115; }
  #container {
    position: fixed; top:0; left:0;
    width: 1024px; height: 1024px;
    transform-origin: 0 0;
  }
  #fpsStats { position: fixed; top: 5px; right: 5px; color: #0f0; font-family: monospace; font-weight: bold; font-size: 14px; z-index: 100; }
  #info { position: fixed; top: 5px; left: 5px; color: #0f0; font-family: monospace; font-weight: bold; font-size: 14px; z-index: 100; }
</style>
</head>
<body>
<div id="container"></div>
<div id="info">滑动旋转，鼠标滚轮缩放</div>
<div id="fpsStats"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stats.js/build/stats.min.js"></script>

<script>
  const container = document.getElementById('container');
  let width = window.innerWidth;
  let height = window.innerHeight;
  if(width > height) width = height;
  else height = width;
  container.style.transform = `scale(${width/1024},${height/1024})`;

  const scene = new THREE.Scene();

  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
  camera.position.set(0, 0, 5);

  const renderer = new THREE.WebGLRenderer({antialias: true});
  renderer.setSize(1024, 1024);
  container.appendChild(renderer.domElement);

  // OrbitControls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minDistance = 1;
  controls.maxDistance = 20;

  // 环境光和点光源
  const ambientLight = new THREE.AmbientLight(0x222222);
  scene.add(ambientLight);

  const pointLight = new THREE.PointLight(0xffffff, 1);
  pointLight.position.set(5, 5, 5);
  scene.add(pointLight);

  // 体积着色器材质 (简化毒蘑菇风格)
  const vertexShader = `
    varying vec3 vPos;
    void main() {
      vPos = position;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
    }
  `;

  const fragmentShader = `
    precision highp float;
    varying vec3 vPos;
    uniform float time;

    // 简单的迭代函数，增加复杂度可自己改
    float kernel(vec3 p){
      vec3 a = p;
      float b,c,d,e;
      for(int i=0;i<6;i++){
        b=length(a);
        c=atan(a.y,a.x)*8.0;
        d=acos(a.z/b)*8.0;
        b=pow(b,8.0);
        a=vec3(b*sin(d)*cos(c),b*sin(d)*sin(c),b*cos(d))+p;
        if(b>6.0) break;
      }
      return 4.0 - dot(a,a);
    }

    void main() {
      vec3 dir = normalize(vPos);
      float v = kernel(dir * 0.8);
      vec3 color = vec3(0.0);
      if(v > 0.0) {
        color = vec3(0.1, 0.7, 0.2) * pow(v, 3.0);
        color += vec3(0.3, 0.5, 0.2) * abs(sin(time));
      }
      gl_FragColor = vec4(color, 1.0);
    }
  `;

  const uniforms = {
    time: { value: 0 }
  };

  const material = new THREE.ShaderMaterial({
    vertexShader,
    fragmentShader,
    uniforms,
    side: THREE.DoubleSide
  });

  // 用一个细分平面承载体积着色器，保证像素密度高
  const geometry = new THREE.PlaneGeometry(3,3,256,256);
  const mesh = new THREE.Mesh(geometry, material);
  scene.add(mesh);

  // 简单粒子系统
  const particleCount = 1500;
  const particlesGeometry = new THREE.BufferGeometry();
  const positions = new Float32Array(particleCount * 3);

  for(let i=0; i<particleCount; i++){
    positions[i*3] = (Math.random()-0.5)*6;
    positions[i*3+1] = (Math.random()-0.5)*6;
    positions[i*3+2] = (Math.random()-0.5)*6;
  }

  particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  const particlesMaterial = new THREE.PointsMaterial({
    color: 0x88ff88,
    size: 0.03,
    sizeAttenuation: true,
    transparent: true,
    opacity: 0.8,
  });

  const particleSystem = new THREE.Points(particlesGeometry, particlesMaterial);
  scene.add(particleSystem);

  // FPS显示
  const stats = new Stats();
  stats.showPanel(0); // 0: fps
  document.getElementById('fpsStats').appendChild(stats.dom);

  // 动画循环
  function animate(time=0){
    stats.begin();
    uniforms.time.value = time * 0.001;

    mesh.rotation.y += 0.005;
    particleSystem.rotation.y += 0.002;

    controls.update();
    renderer.render(scene, camera);
    stats.end();
    requestAnimationFrame(animate);
  }

  animate();

  window.addEventListener('resize', ()=>{
    let w = window.innerWidth;
    let h = window.innerHeight;
    if(w > h) w = h;
    else h = w;
    container.style.transform = `scale(${w/1024},${h/1024})`;
  });
</script>
</body>
</html>