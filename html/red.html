<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatAI - 智能对话助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#F3F4F6',
                        neutral: '#1F2937',
                        'neutral-light': '#F9FAFB',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .chat-bubble-user {
                @apply bg-primary text-white rounded-lg rounded-tl-none p-4 max-w-[80%] ml-auto;
            }
            .chat-bubble-ai {
                @apply bg-secondary text-neutral rounded-lg rounded-tr-none p-4 max-w-[80%] mr-auto;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 h-screen flex flex-col overflow-hidden">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 py-3 px-4 md:px-6 flex items-center justify-between sticky top-0 z-30">
        <div class="flex items-center gap-2">
            <button id="sidebar-toggle" class="md:hidden p-2 rounded-md hover:bg-gray-100">
                <<i class="fa fa-bars text-gray-600"></</i>
            </button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-primary rounded-md flex items-center justify-center">
                    <<i class="fa fa-comments text-white"></</i>
                </div>
                <h1 class="text-xl font-semibold">ChatAI</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button class="hidden md:flex items-center gap-1 text-sm text-gray-600 hover:text-primary transition-colors">
                <<i class="fa fa-cog"></</i>
                <span>设置</span>
            </button>
            <button class="bg-primary text-white px-4 py-2 rounded-md text-sm hover:bg-primary/90 transition-colors">
                登录
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- 左侧侧边栏 - 会话列表 -->
        <aside id="sidebar" class="bg-white border-r border-gray-200 w-64 flex-shrink-0 hidden md:block overflow-y-auto transition-all duration-300 z-20">
            <div class="p-4">
                <button id="new-chat" class="w-full bg-primary text-white py-2 rounded-md flex items-center justify-center gap-2 hover:bg-primary/90 transition-colors">
                    <<i class="fa fa-plus"></</i>
                    <span>新会话</span>
                </button>
            </div>
            
            <div class="px-3 py-2">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">历史会话</h3>
                <div id="chat-history" class="space-y-1">
                    <!-- 历史会话项会动态添加 -->
                    <div class="chat-history-item p-2 rounded-md hover:bg-gray-100 cursor-pointer text-sm flex items-start gap-2">
                        <<i class="fa fa-file-text-o text-gray-400 mt-1"></</i>
                        <span>如何使用API接口？</span>
                    </div>
                    <div class="chat-history-item p-2 rounded-md hover:bg-gray-100 cursor-pointer text-sm flex items-start gap-2">
                        <<i class="fa fa-file-text-o text-gray-400 mt-1"></</i>
                        <span>推荐几本经典书籍</span>
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-0 left-0 w-64 p-4 border-t border-gray-200 bg-white">
                <div class="flex flex-col gap-2 text-sm">
                    <a href="#" class="text-gray-600 hover:text-primary flex items-center gap-2">
                        <<i class="fa fa-question-circle"></</i>
                        <span>帮助中心</span>
                    </a>
                    <a href="#" class="text-gray-600 hover:text-primary flex items-center gap-2">
                        <<i class="fa fa-info-circle"></</i>
                        <span>关于我们</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- 中间主内容区 -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- 对话区域 -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                <!-- 欢迎消息 -->
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0 flex items-center justify-center">
                        <<i class="fa fa-robot text-white text-sm"></</i>
                    </div>
                    <div class="chat-bubble-ai">
                        <p>你好！我是ChatAI，有什么可以帮你的吗？</p>
                    </div>
                </div>
                <!-- 对话内容会动态添加 -->
            </div>

            <!-- 输入区域 -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <div class="flex items-center gap-2 mb-2">
                    <button id="save-chat" class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded-md transition-colors" title="保存会话">
                        <<i class="fa fa-save"></</i>
                    </button>
                    <button class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded-md transition-colors" title="清空对话">
                        <<i class="fa fa-trash"></</i>
                    </button>
                    <button class="p-2 text-gray-600 hover:text-primary hover:bg-gray-100 rounded-md transition-colors" title="复制全部">
                        <<i class="fa fa-copy"></</i>
                    </button>
                </div>
                
                <div class="relative">
                    <textarea 
                        id="user-input" 
                        class="w-full border border-gray-300 rounded-lg p-3 pr-12 focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none min-h-[80px]"
                        placeholder="输入你的问题..."></textarea>
                    <button id="voice-input" class="absolute right-3 top-3 text-gray-500 hover:text-primary">
                        <<i class="fa fa-microphone"></</i>
                    </button>
                </div>
                
                <div class="mt-3 flex justify-end">
                    <button id="send-message" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary/90 transition-colors flex items-center gap-2">
                        <span>发送</span>
                        <<i class="fa fa-paper-plane"></</i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">按 Enter 发送消息，Shift+Enter 换行</p>
            </div>
        </main>

        <!-- 右侧辅助区 -->
        <aside class="w-64 bg-white border-l border-gray-200 hidden lg:block overflow-y-auto p-4">
            <div class="mb-6">
                <h3 class="font-medium mb-3">模型选择</h3>
                <div class="space-y-2">
                    <button class="w-full text-left px-3 py-2 bg-primary/10 text-primary rounded-md text-sm">通用对话</button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded-md text-sm">代码生成</button>
                    <button class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded-md text-sm">文本创作</button>
                </div>
            </div>
            
            <div>
                <h3 class="font-medium mb-3">会话设置</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">回复长度</label>
                        <select class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option>短（约100字）</option>
                            <option selected>中（约300字）</option>
                            <option>长（约500字）</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">创造性（温度值）</label>
                        <input type="range" min="0" max="1" step="0.1" value="0.7" class="w-full accent-primary">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>精确</span>
                            <span>灵活</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // 全局变量
        let currentChatId = null;
        const apiEndpoint = 'https://api.chatanywhere.tech/v1/chat/completions'; // 服务商地址

        // DOM元素
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendMessageBtn = document.getElementById('send-message');
        const newChatBtn = document.getElementById('new-chat');
        const saveChatBtn = document.getElementById('save-chat');
        const chatHistory = document.getElementById('chat-history');

        // 侧边栏切换（移动端）
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('inset-y-0');
            sidebar.classList.toggle('left-0');
            sidebar.classList.toggle('z-50');
        });

        // 发送消息
        sendMessageBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 新建会话
        newChatBtn.addEventListener('click', () => {
            currentChatId = null;
            chatContainer.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0 flex items-center justify-center">
                        <<i class="fa fa-robot text-white text-sm"></</i>
                    </div>
                    <div class="chat-bubble-ai">
                        <p>你好！我是ChatAI，有什么可以帮你的吗？</p>
                    </div>
                </div>
            `;
            userInput.value = '';
        });

        // 保存会话
        saveChatBtn.addEventListener('click', saveCurrentChat);

        // 发送消息函数
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // 添加用户消息到界面
            addMessageToUI('user', message);
            userInput.value = '';

            // 显示加载状态
            const loadingElement = addLoadingIndicator();

            try {
                // 调用API
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('apiKey') || 'sk-qyhKM9JqnrVPDi0uhWpjDiio2yAThQsS43blis8tk3rs9zrm' // 实际项目中需替换为用户输入的API密钥
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'user', content: message }
                        ]
                    })
                });

                const data = await response.json();
                if (data.choices && data.choices.length > 0) {
                    const aiResponse = data.choices[0].message.content;
                    // 添加AI回复到界面
                    addMessageToUI('ai', aiResponse);
                }
            } catch (error) {
                addMessageToUI('ai', `抱歉，请求失败：${error.message}`, true);
            } finally {
                // 移除加载状态
                loadingElement.remove();
                // 自动滚动到底部
                chatContainer.scrollTop = chatContainer.scrollHeight;
                // 自动保存
                autoSaveChat();
            }
        }

        // 添加消息到界面
        function addMessageToUI(role, content, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3';

            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex-shrink-0 flex items-center justify-center">
                        <<i class="fa fa-user text-gray-600 text-sm"></</i>
                    </div>
                    <div class="chat-bubble-user">
                        <p>${content}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0 flex items-center justify-center">
                        <<i class="fa fa-robot text-white text-sm"></</i>
                    </div>
                    <div class="${isError ? 'bg-red-50 text-red-700' : 'chat-bubble-ai'}">
                        <p>${content}</p>
                    </div>
                `;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 添加加载状态
        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex items-start gap-3';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0 flex items-center justify-center">
                    <<i class="fa fa-robot text-white text-sm"></</i>
                </div>
                <div class="chat-bubble-ai">
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            return loadingDiv;
        }

        // 保存会话
        function saveCurrentChat() {
            const firstMessage = chatContainer.querySelector('.chat-bubble-user p')?.textContent || '未命名会话';
            const chatName = firstMessage.length > 20 ? firstMessage.substring(0, 20) + '...' : firstMessage;
            
            // 生成唯一ID
            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
            }
            
            // 保存到本地存储
            const chatData = {
                id: currentChatId,
                name: chatName,
                messages: Array.from(chatContainer.children).map(el => {
                    const bubble = el.querySelector('.chat-bubble-user, .chat-bubble-ai');
                    const role = el.querySelector('.chat-bubble-user') ? 'user' : 'ai';
                    return {
                        role,
                        content: bubble?.querySelector('p')?.textContent || ''
                    };
                }),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(currentChatId, JSON.stringify(chatData));
            
            // 更新会话列表
            updateChatHistory();
            
            // 提示保存成功
            alert('会话已保存');
        }
        
        // 自动保存会话
        function autoSaveChat() {
            if (!currentChatId) return;
            
            const firstMessage = chatContainer.querySelector('.chat-bubble-user p')?.textContent || '未命名会话';
            const chatName = firstMessage.length > 20 ? firstMessage.substring(0, 20) + '...' : firstMessage;
            
            // 保存到本地存储
            const chatData = {
                id: currentChatId,
                name: chatName,
                messages: Array.from(chatContainer.children).map(el => {
                    const userBubble = el.querySelector('.chat-bubble-user');
                    const role = userBubble ? 'user' : 'ai';
                    return {
                        role,
                        content: el.querySelector('p')?.textContent || ''
                    };
                }),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem(currentChatId, JSON.stringify(chatData));
        }
        
        // 更新会话历史列表
        function updateChatHistory() {
            // 清空现有列表（保留默认示例的话可注释此行）
            chatHistory.innerHTML = '';
            
            // 从本地存储获取所有会话
            const chats = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('chat_')) {
                    const chat = JSON.parse(localStorage.getItem(key));
                    chats.push(chat);
                }
            }
            
            // 按时间排序（最新的在前）
            chats.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // 添加到历史列表
            chats.forEach(chat => {
                const historyItem = document.createElement('div');
                historyItem.className = 'chat-history-item p-2 rounded-md hover:bg-gray-100 cursor-pointer text-sm flex items-start gap-2';
                historyItem.innerHTML = `
                    <<i class="fa fa-file-text-o text-gray-400 mt-1"></</i>
                    <span>${chat.name}</span>
                `;
                
                // 点击加载会话
                historyItem.addEventListener('click', () => loadChat(chat.id));
                chatHistory.appendChild(historyItem);
            });
        }
        
        // 加载历史会话
        function loadChat(chatId) {
            currentChatId = chatId;
            const chatData = JSON.parse(localStorage.getItem(chatId));
            if (!chatData) return;
            
            // 清空当前对话
            chatContainer.innerHTML = '';
            
            // 加载消息
            chatData.messages.forEach(msg => {
                addMessageToUI(msg.role, msg.content);
            });
            
            // 移动端自动隐藏侧边栏
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
            }
        }
        
        // 初始化页面
        function init() {
            // 加载历史会话列表
            updateChatHistory();
            
            // 初始化API地址（可在设置中修改）
            document.querySelector('button:has(.fa-cog)').addEventListener('click', () => {
                const newApi = prompt('修改API地址', apiEndpoint);
                if (newApi) {
                    // 实际项目中可在这里更新全局apiEndpoint变量
                    alert(`API地址已更新为：${newApi}`);
                }
            });
            
            // 清空对话按钮
            document.querySelector('button:has(.fa-trash)').addEventListener('click', () => {
                if (confirm('确定要清空当前对话吗？')) {
                    chatContainer.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-primary rounded-full flex-shrink-0 flex items-center justify-center">
                                <<i class="fa fa-robot text-white text-sm"></</i>
                            </div>
                            <div class="chat-bubble-ai">
                                <p>你好！我是ChatAI，有什么可以帮你的吗？</p>
                            </div>
                        </div>
                    `;
                    currentChatId = null;
                }
            });
            
            // 复制全部按钮
            document.querySelector('button:has(.fa-copy)').addEventListener('click', () => {
                const messages = Array.from(chatContainer.children).map(el => {
                    const role = el.querySelector('.chat-bubble-user') ? '你' : 'AI';
                    const content = el.querySelector('p')?.textContent || '';
                    return `${role}：${content}`;
                }).join('\n\n');
                
                navigator.clipboard.writeText(messages).then(() => {
                    alert('已复制全部对话内容');
                });
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
