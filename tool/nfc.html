<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WebNFC — 25914</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#3b82f6; --muted:#93c5fd;
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",arial;
    background:linear-gradient(180deg,var(--bg),#071024);
    color:#e6eef8;
    min-height:100vh;
    padding:20px;
  }
  .app{width:100%;max-width:920px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#052237}
  h1{font-size:18px;margin:0}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:14px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6);margin-bottom:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  button{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:#03203a;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .area{display:flex;gap:12px;flex-wrap:wrap}
  .panel{flex:1;min-width:260px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="file"]{color:inherit}
  textarea{width:100%;height:120px;border-radius:10px;padding:10px;border:0;background:transparent;color:inherit;resize:vertical;border:1px solid rgba(255,255,255,0.03)}
  .log{font-family:monospace;font-size:13px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.15);max-height:220px;overflow:auto}
  .preview{margin-top:10px;border-radius:8px;overflow:auto;padding:12px;background:rgba(0,0,0,0.06);min-height:120px;display:flex;flex-direction:column;gap:12px}
  img.preview-img{max-width:100%;height:auto;display:block;margin:0 auto;border-radius:6px}
  audio,video{width:100%;display:block;border-radius:6px}
  .note{font-size:12px;color:#9fbbe8;margin-top:8px}
  footer{font-size:13px;color:var(--muted);margin-top:8px;text-align:center}
  @media (max-width:640px){header h1{font-size:16px}.area{flex-direction:column}}
  .download-link{display:inline-block;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.03);color:var(--muted);text-decoration:none}
  .text-content{white-space:pre-wrap;word-break:break-word;color:inherit}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">NFC</div>
      <div>
        <h1>WebNFC Reader / Writer</h1>
        <div class="note">说明：预览区只显示 NFC 中的“真实内容”。每次读取会清空上一次的预览（一次性），日志区保留启动/停止/写入/错误等信息。</div>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <button id="startScan">启动读取（Scan）</button>
        <button id="stopScan" class="ghost">停止读取</button>
        <button id="writeText">写文本到标签</button>
        <button id="writeURL" class="ghost">写 URL 到标签</button>
        <button id="writeFile" class="ghost">写文件到标签（小文件）</button>
      </div>

      <div class="area">
        <div class="panel">
          <label>写入：文本</label>
          <textarea id="textToWrite" placeholder="这里输入要写入 NFC 标签的文字（短文本优先）">测试 Web NFC 文本</textarea>

          <label style="margin-top:10px">写入：URL</label>
          <input id="urlToWrite" type="url" placeholder="https://example.com/your-file.jpg" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" />

          <label style="margin-top:10px">写入：文件（小于 3KB 推荐）</label>
          <input id="fileToWrite" type="file" accept="image/*,audio/*,video/*,text/*" />
          <div class="note">建议：若文件较大，先上传到服务器并写入 URL。直接写文件有容量限制。</div>
        </div>

        <div class="panel">
          <label>读取结果（只显示 NFC 里的真实内容）</label>
          <div id="preview" class="preview" aria-live="polite"></div>

          <div class="note" style="margin-top:8px">调试/状态日志（启动/停止/错误/写入等）：</div>
          <div id="log" class="log" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <footer>页面须为 HTTPS；请在支持 Web NFC 的 Android Chromium 浏览器中测试。</footer>
  </div>

<script>
(function(){
  const logEl = document.getElementById('log');
  const previewEl = document.getElementById('preview');
  let createdObjectURLs = []; // 存放创建的 object URLs，便于下次清理
  let ndefRef = null;

  function log(...args){
    const now = new Date().toISOString().replace('T',' ').slice(0,19);
    const text = args.map(a => typeof a === 'object' ? JSON.stringify(a,null,2) : String(a)).join(' ');
    logEl.innerText = `[${now}] ${text}\n` + logEl.innerText;
    // 控制日志最大长度
    if (logEl.innerText.length > 20000) logEl.innerText = logEl.innerText.slice(0, 20000);
  }

  function clearPreviewAndRevokeURLs(){
    // 释放之前创建的 object URLs
    createdObjectURLs.forEach(url => {
      try { URL.revokeObjectURL(url); } catch(e){}
    });
    createdObjectURLs = [];
    previewEl.innerHTML = '';
  }

  function toUint8ArrayFromRecordData(data){
    // 支持 DataView, ArrayBuffer, TypedArray, Uint8Array 等
    if (!data) return null;
    if (data instanceof DataView) {
      return new Uint8Array(data.buffer, data.byteOffset, data.byteLength);
    }
    if (data instanceof ArrayBuffer) {
      return new Uint8Array(data);
    }
    if (ArrayBuffer.isView(data)) {
      // TypedArray including Uint8Array
      return new Uint8Array(data.buffer, data.byteOffset || 0, data.byteLength || data.buffer.byteLength);
    }
    try {
      // 最后尝试 JSON-ish decode fallback
      return new Uint8Array(data);
    } catch(e){
      return null;
    }
  }

  async function handleNdefReading(event){
    // 每次读取先清空上次预览（一次性），并释放之前的 URL
    clearPreviewAndRevokeURLs();

    const msg = event.message;
    // For each record, only display the content (no extra meta in preview).
    for (const r of msg.records) {
      try {
        if (r.recordType === 'text') {
          const arr = toUint8ArrayFromRecordData(r.data);
          let text = '';
          if (arr) {
            // Web NFC text records usually include status byte and language code; but many implementations already provide only payload text.
            // To be safe, attempt to decode as utf-8 and, if it starts with 0x00/0x02 etc, try to remove status byte following spec.
            try {
              // Decode raw, then try to remove leading status byte + language code if present
              const full = new TextDecoder('utf-8').decode(arr);
              // If we detect pattern like status(1byte) + language code + text, quick heuristic:
              // If first byte is small and following characters are ascii letters (language tag), strip first 1+lang.length bytes.
              // But to avoid displaying metadata, we will attempt simple decode: if first byte is in 0..3 and following bytes contain ASCII letters then skip first byte and possible lang.
              const firstByte = arr[0];
              if (firstByte <= 3 && arr.length > 1) {
                // try to detect language code length by reading until next non-letter char
                let langLen = 0;
                for (let i = 1; i < arr.length; i++){
                  const c = arr[i];
                  if ((c >= 0x61 && c <= 0x7A) || (c >= 0x41 && c <= 0x5A) || c === 0x2D) { langLen++; continue; }
                  break;
                }
                // decode without the status + lang bytes
                try {
                  text = new TextDecoder('utf-8').decode(arr.subarray(1 + langLen));
                } catch(e) {
                  text = full; // fallback
                }
              } else {
                text = full;
              }
            } catch(e){
              text = '';
            }
          }
          const div = document.createElement('div');
          div.className = 'text-content';
          div.textContent = text;
          previewEl.appendChild(div);

        } else if (r.recordType === 'url') {
          const arr = toUint8ArrayFromRecordData(r.data);
          let url = '';
          if (arr) {
            try { url = new TextDecoder('utf-8').decode(arr); } catch(e){ url = ''; }
          }
          const a = document.createElement('a');
          a.href = url || '#';
          a.textContent = url || '[空 URL]';
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'download-link';
          a.style.wordBreak = 'break-all';
          previewEl.appendChild(a);

        } else if (r.recordType === 'mime') {
          const mediaType = r.mediaType || 'application/octet-stream';
          const arr = toUint8ArrayFromRecordData(r.data);
          const blob = arr ? new Blob([arr], {type: mediaType}) : null;

          if (blob && mediaType.startsWith('image/')) {
            const img = document.createElement('img');
            img.className = 'preview-img';
            img.src = URL.createObjectURL(blob);
            createdObjectURLs.push(img.src);
            previewEl.appendChild(img);

          } else if (blob && mediaType.startsWith('audio/')) {
            const au = document.createElement('audio');
            au.controls = true;
            au.src = URL.createObjectURL(blob);
            createdObjectURLs.push(au.src);
            previewEl.appendChild(au);

          } else if (blob && mediaType.startsWith('video/')) {
            const v = document.createElement('video');
            v.controls = true;
            v.src = URL.createObjectURL(blob);
            createdObjectURLs.push(v.src);
            previewEl.appendChild(v);

          } else if (blob && mediaType.startsWith('text/')) {
            try {
              const text = await blob.text();
              const div = document.createElement('div');
              div.className = 'text-content';
              div.textContent = text;
              previewEl.appendChild(div);
            } catch(e){
              const dl = document.createElement('a');
              dl.href = URL.createObjectURL(blob);
              createdObjectURLs.push(dl.href);
              dl.download = 'file';
              dl.className = 'download-link';
              dl.textContent = '下载';
              previewEl.appendChild(dl);
            }

          } else if (blob) {
            // 其他 MIME 类型，仅提供下载（不显示元信息）
            const dl = document.createElement('a');
            dl.href = URL.createObjectURL(blob);
            createdObjectURLs.push(dl.href);
            dl.download = 'file';
            dl.className = 'download-link';
            dl.textContent = '下载';
            previewEl.appendChild(dl);

          } else {
            // 无法构造 blob 的情况：尝试把 bytes 解为文本并显示，否则给出不可显示提示
            if (arr) {
              try {
                const txt = new TextDecoder('utf-8').decode(arr);
                const div = document.createElement('div');
                div.className = 'text-content';
                div.textContent = txt;
                previewEl.appendChild(div);
              } catch(e) {
                const div = document.createElement('div');
                div.className = 'text-content';
                div.textContent = '[无法直接显示该记录内容]';
                previewEl.appendChild(div);
              }
            } else {
              const div = document.createElement('div');
              div.className = 'text-content';
              div.textContent = '[无法直接显示该记录内容]';
              previewEl.appendChild(div);
            }
          }

        } else {
          // 其他 recordType：尝试解码为文本，失败的话提供下载
          const arr = toUint8ArrayFromRecordData(r.data);
          if (arr) {
            try {
              const txt = new TextDecoder('utf-8').decode(arr);
              const div = document.createElement('div');
              div.className = 'text-content';
              div.textContent = txt;
              previewEl.appendChild(div);
            } catch(e) {
              const blob = new Blob([arr], {type: 'application/octet-stream'});
              const dl = document.createElement('a');
              dl.href = URL.createObjectURL(blob);
              createdObjectURLs.push(dl.href);
              dl.download = 'file';
              dl.className = 'download-link';
              dl.textContent = '下载';
              previewEl.appendChild(dl);
            }
          } else {
            const div = document.createElement('div');
            div.className = 'text-content';
            div.textContent = '[该 recordType 无可显示内容]';
            previewEl.appendChild(div);
          }
        }
      } catch (err) {
        // 错误只写入日志，不暴露到 preview
        log('处理 record 出错：' + String(err));
      }
    }

    // 记录扫描到事件（写入日志，但不在 preview 中显示其他信息）
    log('读取到标签（records=' + msg.records.length + '）');
  }

  async function startScan(){
    if (!('NDEFReader' in window)) {
      alert('当前浏览器不支持 Web NFC (NDEFReader 未发现)。');
      return;
    }
    try {
      // 如果已有扫描句柄，先尝试停止旧的
      if (ndefRef && ndefRef.onreading) {
        ndefRef.onreading = null;
        ndefRef.onreadingerror = null;
        ndefRef = null;
      }
      const ndef = new NDEFReader();
      await ndef.scan();
      ndefRef = ndef;
      ndef.onreading = handleNdefReading;
      ndef.onreadingerror = () => log('读取错误：无法读取标签。');
      log('已开始扫描 — 将标签靠近设备');
    } catch (e) {
      log('开启扫描失败：' + String(e));
      alert('开启扫描失败：' + e);
    }
  }

  function stopScan(){
    if (ndefRef) {
      try {
        ndefRef.onreading = null;
        ndefRef.onreadingerror = null;
        ndefRef = null;
        log('已停止扫描。');
      } catch(e) {
        log('停止扫描失败：' + String(e));
      }
    } else {
      log('未在扫描中。');
    }
  }

  async function writeText(){
    const t = document.getElementById('textToWrite').value || '';
    if (!t) { alert('先输入要写的文本'); return; }
    if (!('NDEFReader' in window)) { alert('当前浏览器不支持 Web NFC (NDEFReader 未发现)。'); return; }
    try {
      const ndef = new NDEFReader();
      await ndef.write({records: [{recordType: 'text', data: t}]});
      log('写入文本成功');
    } catch (e) {
      log('写入文本失败：' + String(e));
      alert('写入失败: ' + e);
    }
  }

  async function writeURL(){
    const u = document.getElementById('urlToWrite').value || '';
    if (!u) { alert('先输入要写的 URL'); return; }
    try {
      const ndef = new NDEFReader();
      await ndef.write({records: [{recordType: 'url', data: u}]});
      log('写入 URL 成功');
    } catch (e) {
      log('写入 URL 失败：' + String(e));
      alert('写入失败: ' + e);
    }
  }

  async function writeFile(){
    const file = document.getElementById('fileToWrite').files[0];
    if (!file) { alert('先选择一个文件'); return; }
    if (file.size > 4096) {
      if (!confirm('文件大于4KB，标签可能无法保存。是否继续（建议先上传到服务器并写入 URL）？')) return;
    }
    try {
      const arr = await file.arrayBuffer();
      const ndef = new NDEFReader();
      await ndef.write({records: [{recordType: 'mime', mediaType: file.type || 'application/octet-stream', data: arr}]});
      log('写入文件成功：' + file.name);
    } catch (e) {
      log('写入文件失败：' + String(e));
      alert('写入失败: ' + e);
    }
  }

  // 绑定按钮
  document.getElementById('startScan').addEventListener('click', startScan);
  document.getElementById('stopScan').addEventListener('click', stopScan);
  document.getElementById('writeText').addEventListener('click', writeText);
  document.getElementById('writeURL').addEventListener('click', writeURL);
  document.getElementById('writeFile').addEventListener('click', writeFile);

  // 页面可见性提醒（写入日志，不影响 preview）
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) log('页面不可见：部分 NFC 操作可能被阻止。');
  });

})();
</script>
</body>
</html>